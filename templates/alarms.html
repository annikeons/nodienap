<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarmas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='stylex.css') }}">
</head>

<body>

    <div id="alarm" class="section active">
        <h1 class="wapi">Alarmas</h1>
        <div class="alarm-container">
            <button type="button" id="btnActivarSonido" style="margin-bottom:10px;">üîä Activar sonido</button>
            <label>Hora:</label>
            <input type="time" id="alarmTime">
            <label>Sonido:</label>
            <select id="alarmSound">
                <option value="sound1">Sonido 1 (llulaby)</option>
                <option value="sound2">Sonido 2 (forest)</option>
                <option value="sound3">Sonido 3 (a very brady special)</option>
                <option value="sound4">Sonido 4 (ancient winds)</option>
                <option value="sound5">Sonido 5 (isolation waltz)</option>
                <option value="sound6">Sonido 6 (connecting rainbows)</option>
            </select>
            <label><input type="checkbox" id="alarmActive"> Activar alarma</label>
            <button type="button" id="addAlarm">Agregar alarma</button>
            <div class="alarm-list" id="alarmList"></div>
        </div>
    </div>

    <div id="alarmMessage" style="margin-top:10px; font-weight:bold; color:#b30000;"></div>

    <script>
        (function () {
            var audioEnabled = false;
            var alarms = [];
            var activeAudios = {};
            var alarmList = document.getElementById('alarmList');
            var btnActivar = document.getElementById('btnActivarSonido');

            // Listen for messages from parent
            window.addEventListener('message', function (event) {
                if (event.data.type === 'audioUnlocked') {
                    audioEnabled = true;
                    console.log("Audio unlocked by parent");
                }
                if (event.data.type === 'applyTheme') {
                    document.body.classList.toggle('dark', event.data.theme === 'dark');
                }
            });

            document.getElementById('addAlarm').addEventListener('click', function () {
                var time = document.getElementById('alarmTime').value;
                var sound = document.getElementById('alarmSound').value;
                var active = document.getElementById('alarmActive').checked;
                if (!time) { alert("Selecciona una hora"); return; }
                var id = Date.now();
                alarms.push({ id: id, time: time, sound: sound, active: active, ringing: false });
                renderAlarms();
            });

            function enableAudio() {
                if (audioEnabled) {
                    alert("üîä El sonido ya est√° activado");
                    return;
                }
                var test = new Audio("https://freepd.com/music/Wind%20of%20the%20Rainforest.mp3");
                test.volume = 0.01;
                test.loop = false;
                var p = test.play();
                if (p && typeof p.then === 'function') {
                    p.then(function () {
                        test.pause();
                        test.currentTime = 0;
                        audioEnabled = true;
                        alert("üîä Sonido activado. Las alarmas ya pueden sonar.");
                    }).catch(function (err) {
                        console.error("Audio:", err);
                        alert("‚ö†Ô∏è Pulsa el bot√≥n para habilitar el sonido (los navegadores requieren interacci√≥n del usuario).");
                    });
                } else {
                    audioEnabled = true;
                    alert("üîä Sonido activado");
                }
            }

            btnActivar.addEventListener('click', function () { enableAudio(); });

            function playSound(alarmId, sound) {
                if (!audioEnabled) {
                    alert("üîä Primero pulsa 'Activar sonido'");
                    return;
                }
                stopAlarm(alarmId);
                var audio = new Audio();
                var urls = {
                    sound1: 'https://pixabay.com/es/music/cl%c3%a1sico-moderno-kaijin-sea-god-465195/',
                    sound2: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                    sound3: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3',
                    sound4: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3',
                    sound5: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3',
                    sound6: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3'
                };
                audio.src = urls[sound] || urls.sound1;
                audio.loop = true;
                audio.play().catch(function (e) {
                    console.error("Error audio:", e);
                    alert("‚ö†Ô∏è Error al cargar el sonido. Intenta con otro o pulsa 'Activar sonido'.");
                });
                activeAudios[alarmId] = audio;
            }

            function stopAlarm(alarmId) {
                if (activeAudios[alarmId]) {
                    activeAudios[alarmId].pause();
                    activeAudios[alarmId].currentTime = 0;
                    delete activeAudios[alarmId];
                }
            }

            function renderAlarms() {
                alarmList.innerHTML = '';
                alarms.forEach(function (alarm) {
                    var div = document.createElement('div');
                    div.className = 'alarm-item';
                    div.style.background = alarm.ringing ? '#ffecd2' : '';
                    div.style.border = alarm.ringing ? '2px solid #ffb347' : '1px solid rgba(0,0,0,0.05)';

                    var content = document.createElement('div');
                    content.style.flex = '1';
                    content.innerHTML = '<strong style="font-size:1.2rem; display:block;">' + alarm.time + '</strong>' +
                        '<small style="color:#666;">' + alarm.sound + '</small>';

                    var controls = document.createElement('div');
                    controls.style.display = 'flex';
                    controls.style.gap = '8px';
                    controls.style.alignItems = 'center';

                    var activeLabel = document.createElement('label');
                    activeLabel.style.fontSize = '0.9rem';
                    activeLabel.innerHTML = '<input type="checkbox" ' + (alarm.active ? 'checked' : '') + '> ' + (alarm.active ? 'On' : 'Off');
                    activeLabel.querySelector('input').onchange = function (e) { window.toggleAlarm(alarm.id, e.target.checked); };

                    var btnStop = document.createElement('button');
                    btnStop.textContent = 'Detener';
                    btnStop.style.background = '#ffb347';
                    btnStop.style.display = alarm.active ? 'block' : 'none';
                    btnStop.onclick = function () { window.stopAlarm(alarm.id); };

                    var btnRemove = document.createElement('button');
                    btnRemove.textContent = 'Quitar';
                    btnRemove.style.background = '#ff6b6b';
                    btnRemove.onclick = function () { window.removeAlarm(alarm.id); };

                    controls.appendChild(activeLabel);
                    if (alarm.ringing) controls.appendChild(btnStop);
                    controls.appendChild(btnRemove);

                    div.appendChild(content);
                    div.appendChild(controls);
                    alarmList.appendChild(div);
                });
            }

            function toggleAlarm(id, status) {
                var a = alarms.filter(function (x) { return x.id === id; })[0];
                if (a) a.active = status;
                renderAlarms();
            }

            function removeAlarm(id) {
                alarms = alarms.filter(function (a) { return a.id !== id; });
                stopAlarm(id);
                renderAlarms();
            }

            window.toggleAlarm = toggleAlarm;
            window.removeAlarm = removeAlarm;
            window.stopAlarm = stopAlarm;

            function showAlarmMessage(msg) {
                var div = document.getElementById('alarmMessage');
                div.style.display = 'block';
                div.innerText = msg;
                setTimeout(function () { div.style.display = 'none'; }, 30000);
            }

            setInterval(function () {
                var now = new Date();
                var currentTime = now.toTimeString().slice(0, 5);
                alarms.forEach(function (alarm) {
                    if (alarm.active && alarm.time === currentTime && !alarm.ringing) {
                        alarm.ringing = true;
                        playSound(alarm.id, alarm.sound);
                        showAlarmMessage("¬°Alarma! Hora: " + alarm.time);
                        setTimeout(function () { alarm.ringing = false; }, 60000);
                    }
                });
            }, 1000);
        })();
    </script>

</body>

</html>