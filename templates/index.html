<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nodie</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='stylex.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='sleeper duck.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#ffd500">
</head>
<body>

    <div class="content">
        <div id="home" class="section active">
            <h1 class="animated-text">¬°Que gusto verte!</h1>
            <p class="clancy">Nodie, tu pausa ideal para relajarte<br><br></p>
            <h1 class="animated-text">Palabras Para Ti:</h1>
            <div class="cards consejo-box consejo-card">
                <div class="card">
                    <img src="{{ url_for('static', filename='sleeper duck.png') }}" alt="Nodie">
                    <p id="consejo-texto">Las alarmas no solo son para cuando duermes, tambi√©n cuando est√°s activo y quieres sonidos relajantes</p>
                </div>
            </div>
        </div>

        <div id="nodie" class="section">
            <h1 class="uwu">Nodie</h1>
            <iframe src="/chat" style="width:100%; height:440px; border:none; border-radius:15px;" title="Chatbot Nodie"></iframe>
        </div>



        <div id="alarm" class="section">
            <h1 class="uwu">Alarma</h1>
           <div id="alarm" class="section active">
        <h1 class="wapi">Alarmas</h1>
        <div class="alarm-container">
            <button type="button" id="btnActivarSonido" style="margin-bottom:10px;">üîä Activar sonido</button>
            <label>Hora:</label>
            <input type="time" id="alarmTime">
            <label>Sonido:</label>
            <select id="alarmSound">
                <option value="sound1">Sonido 1 (Ambient relax)</option>
                <option value="sound2">Sonido 2 (Meditation)</option>
                <option value="sound3">Sonido 3 (Sleep meditation music)</option>
                <option value="sound4">Sonido 4 (Instrumental llulaby)</option>
                <option value="sound5">Sonido 5 (Relaxing Synth Harmonies)</option>
                <option value="sound6">Sonido 6 (Deep ambient)</option>
            </select>
            <label><input type="checkbox" id="alarmActive"> Activar alarma</label>
            <button type="button" id="addAlarm">Agregar alarma</button>
            <div class="alarm-list" id="alarmList"></div>
        </div>
    </div>

    <div id="alarmMessage" style="margin-top:10px; font-weight:bold; color:#b30000;"></div>

    <script>
        (function () {
            var audioEnabled = false;
            var alarms = [];
            var activeAudios = {};
            var alarmList = document.getElementById('alarmList');
            var btnActivar = document.getElementById('btnActivarSonido');

            // Listen for messages from parent
            window.addEventListener('message', function (event) {
                if (event.data.type === 'audioUnlocked') {
                    audioEnabled = true;
                    console.log("Audio unlocked by parent");
                }
                if (event.data.type === 'applyTheme') {
                    document.body.classList.toggle('dark', event.data.theme === 'dark');
                }
            });

            document.getElementById('addAlarm').addEventListener('click', function () {
                var time = document.getElementById('alarmTime').value;
                var sound = document.getElementById('alarmSound').value;
                var active = document.getElementById('alarmActive').checked;
                if (!time) { alert("Selecciona una hora"); return; }
                var id = Date.now();
                alarms.push({ id: id, time: time, sound: sound, active: active, ringing: false });
                renderAlarms();
            });

            function enableAudio() {
                if (audioEnabled) {
                    alert("üîä El sonido ya est√° activado");
                    return;
                }
                var test = new Audio("");
                test.volume = 0.01;
                test.loop = false;
                var p = test.play();
                if (p && typeof p.then === 'function') {
                    p.then(function () {
                        test.pause();
                        test.currentTime = 0;
                        audioEnabled = true;
                        alert("üîä Sonido activado. Las alarmas ya pueden sonar.");
                    }).catch(function (err) {
                        console.error("Audio:", err);
                        alert("‚ö†Ô∏è Pulsa el bot√≥n para habilitar el sonido (los navegadores requieren interacci√≥n del usuario).");
                    });
                } else {
                    audioEnabled = true;
                    alert("üîä Sonido activado");
                }
            }

            btnActivar.addEventListener('click', function () { enableAudio(); });

            function playSound(alarmId, sound) {
                if (!audioEnabled) {
                    alert("üîä Primero pulsa 'Activar sonido'");
                    return;
                }
                stopAlarm(alarmId);
                var audio = new Audio();
                var urls = {
                    sound1: 'https://orangefreesounds.com/wp-content/uploads/2023/01/Ambient-relaxing-music.mp3',
                    sound2: 'https://www.orangefreesounds.com/wp-content/uploads/2020/07/Free-meditation-music.mp3',
                    sound3: 'https://orangefreesounds.com/wp-content/uploads/2023/01/Sleep-meditation-music-free.mp3',
                    sound4: 'https://orangefreesounds.com/wp-content/uploads/2023/07/Free-instrumental-lullaby-music.mp3',
                    sound5: 'https://orangefreesounds.com/wp-content/uploads/2024/01/Relaxing-synth-harmonies.mp3',
                    sound6: 'https://www.orangefreesounds.com/wp-content/uploads/2020/11/Deep-ambient-music.mp3'
                };
                audio.src = urls[sound] || urls.sound1;
                audio.loop = true;
                audio.play().catch(function (e) {
                    console.error("Error audio:", e);
                    alert("‚ö†Ô∏è Error al cargar el sonido. Intenta con otro o pulsa 'Activar sonido'.");
                });
                activeAudios[alarmId] = audio;
            }

            function stopAlarm(alarmId) {
                if (activeAudios[alarmId]) {
                    activeAudios[alarmId].pause();
                    activeAudios[alarmId].currentTime = 0;
                    delete activeAudios[alarmId];
                }
            }

            function renderAlarms() {
                alarmList.innerHTML = '';
                alarms.forEach(function (alarm) {
                    var div = document.createElement('div');
                    div.className = 'alarm-item';
                    div.style.background = alarm.ringing ? '#ffecd2' : '';
                    div.style.border = alarm.ringing ? '2px solid #ffb347' : '1px solid rgba(0,0,0,0.05)';

                    var content = document.createElement('div');
                    content.style.flex = '1';
                    content.innerHTML = '<strong style="font-size:1.2rem; display:block;">' + alarm.time + '</strong>' +
                        '<small style="color:#666;">' + alarm.sound + '</small>';

                    var controls = document.createElement('div');
                    controls.style.display = 'flex';
                    controls.style.gap = '8px';
                    controls.style.alignItems = 'center';

                    var activeLabel = document.createElement('label');
                    activeLabel.style.fontSize = '0.9rem';
                    activeLabel.innerHTML = '<input type="checkbox" ' + (alarm.active ? 'checked' : '') + '> ' + (alarm.active ? 'On' : 'Off');
                    activeLabel.querySelector('input').onchange = function (e) { window.toggleAlarm(alarm.id, e.target.checked); };

                    var btnStop = document.createElement('button');
                    btnStop.textContent = 'Detener';
                    btnStop.style.background = '#ffb347';
                    btnStop.style.display = alarm.active ? 'block' : 'none';
                    btnStop.onclick = function () { window.stopAlarm(alarm.id); };

                    var btnRemove = document.createElement('button');
                    btnRemove.textContent = 'Quitar';
                    btnRemove.style.background = '#ff6b6b';
                    btnRemove.onclick = function () { window.removeAlarm(alarm.id); };

                    controls.appendChild(activeLabel);
                    if (alarm.ringing) controls.appendChild(btnStop);
                    controls.appendChild(btnRemove);

                    div.appendChild(content);
                    div.appendChild(controls);
                    alarmList.appendChild(div);
                });
            }

            function toggleAlarm(id, status) {
                var a = alarms.filter(function (x) { return x.id === id; })[0];
                if (a) a.active = status;
                renderAlarms();
            }

            function removeAlarm(id) {
                alarms = alarms.filter(function (a) { return a.id !== id; });
                stopAlarm(id);
                renderAlarms();
            }

            window.toggleAlarm = toggleAlarm;
            window.removeAlarm = removeAlarm;
            window.stopAlarm = stopAlarm;

            function showAlarmMessage(msg) {
                var div = document.getElementById('alarmMessage');
                div.style.display = 'block';
                div.innerText = msg;
                setTimeout(function () { div.style.display = 'none'; }, 30000);
            }

            setInterval(function () {
                var now = new Date();
                var currentTime = now.toTimeString().slice(0, 5);
                alarms.forEach(function (alarm) {
                    if (alarm.active && alarm.time === currentTime && !alarm.ringing) {
                        alarm.ringing = true;
                        playSound(alarm.id, alarm.sound);
                        showAlarmMessage("¬°Alarma! Hora: " + alarm.time);
                        setTimeout(function () { alarm.ringing = false; }, 60000);
                    }
                });
            }, 1000);
        })();
    </script>
        </div>




        <div id="events" class="section">
            <h1 class="uwu">Eventos</h1>
           <div id="events" class="section active">
        <h1>Pendientes</h1>
        <div class="event-form">
            <input type="text" id="eventName" placeholder="Nombre del evento">
            <input type="time" id="eventStart" placeholder="Inicio">
            <input type="time" id="eventEnd" placeholder="Fin">
            <button type="button" id="addEvent">Agregar Pendiente</button>
        </div>
        <div class="cards" id="eventList"></div>
    </div>

    <script>
        (function () {
            // Theme sync listener
            window.addEventListener('message', function (event) {
                if (event.data.type === 'applyTheme') {
                    document.body.classList.toggle('dark', event.data.theme === 'dark');
                }
            });

            var eventList = document.getElementById('eventList');
            var addBtn = document.getElementById('addEvent');

            function loadEvents() {
                var events = JSON.parse(localStorage.getItem('events') || '[]');
                eventList.innerHTML = '';
                events.forEach(function (ev, index) {
                    var div = document.createElement('div');
                    div.className = 'card';
                    div.style.marginBottom = '15px';
                    div.style.padding = '20px';
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'space-between';
                    div.style.background = 'rgba(255, 255, 255, 0.8)';
                    div.style.borderRadius = '16px';

                    var info = document.createElement('div');
                    info.style.display = 'flex';
                    info.style.alignItems = 'center';
                    info.style.gap = '15px';
                    info.innerHTML = '<img src="' + "{{ url_for('static', filename='agenda.png') }}" + '" style="width:40px; height:40px;">' +
                        '<div><strong style="display:block; font-size:1.1rem;">' + ev.name + '</strong>' +
                        '<span style="color:#666; font-size:0.9rem;">' + ev.start + ' - ' + ev.end + '</span></div>';

                    var btnDelete = document.createElement('button');
                    btnDelete.innerHTML = '‚ùé';
                    btnDelete.className = 'delete-btn';
                    btnDelete.dataset.index = index;
                    btnDelete.style.background = 'transparent';
                    btnDelete.style.boxShadow = 'none';
                    btnDelete.style.fontSize = '1.2rem';
                    btnDelete.style.padding = '5px';

                    div.appendChild(info);
                    div.appendChild(btnDelete);
                    eventList.appendChild(div);
                });
            }

            addBtn.addEventListener('click', function () {
                var name = document.getElementById('eventName').value.trim();
                var start = document.getElementById('eventStart').value;
                var end = document.getElementById('eventEnd').value;
                if (!name || !start || !end) { alert("Completa todos los campos"); return; }
                var events = JSON.parse(localStorage.getItem('events') || '[]');
                events.push({ name: name, start: start, end: end });
                localStorage.setItem('events', JSON.stringify(events));
                loadEvents();
                document.getElementById('eventName').value = '';
                document.getElementById('eventStart').value = '';
                document.getElementById('eventEnd').value = '';
            });

            eventList.addEventListener('click', function (e) {
                if (!e.target.classList.contains('delete-btn')) return;
                var index = parseInt(e.target.getAttribute('data-index'), 10);
                var events = JSON.parse(localStorage.getItem('events') || '[]');
                events.splice(index, 1);
                localStorage.setItem('events', JSON.stringify(events));
                loadEvents();
            });

            loadEvents();
        })();
    </script>
        </div>




        <div id="settings" class="section">
            <h1 class="uwu">Ayuda</h1>
             <div id="settings" class="section active">
        <h1 class="uwu">Centro de Ayuda</h1>

        <div class="config-item glass-card" style="padding:15px; margin-bottom:20px;">
            <label style="display:block; margin-bottom:10px; font-weight:bold;">üåì Personalizaci√≥n:</label>
            <select id="themeSelect" style="width:100%;">
                <option value="light">‚òÄÔ∏è Modo Claro</option>
                <option value="dark">üåë Modo Oscuro</option>
            </select>
        </div>

        <div class="ayuda-content" style="text-align:left; line-height:1.6;">
            <h3 style="color:#ffb347;">ü¶Ü ¬øQu√© es Nodie?</h3>
            <p>Nodie es tu asistente de relajaci√≥n personal. Dise√±ado para ayudarte a tomar pausas conscientes,
                gestionar tus pendientes y relajarte con sonidos ambientales.</p>

            <h3 style="color:#ffb347; margin-top:20px;">üïú Uso de Alarmas</h3>
            <ul style="padding-left:20px;">
                <li>Pulsa <strong>"Activar sonido"</strong> al entrar para habilitar el audio en tu navegador.</li>
                <li>Elige un sonido relajante y configura la hora de tu pausa.</li>
                <li>Recuerda que las alarmas solo suenan si la pesta√±a est√° abierta.</li>
            </ul>

            <h3 style="color:#ffb347; margin-top:20px;">üí¨ Hablar con Nodie</h3>
            <p>En la pesta√±a <strong>"Nodie"</strong>, puedes chatear con nuestro patito relajante. Cu√©ntale tu d√≠a o
                pide un consejo.</p>

            <h3 style="color:#ffb347; margin-top:20px;">üìã Pendientes</h3>
            <p>Organiza tus tareas diarias en la secci√≥n de Pendientes para que no olvides tus momentos de descanso.</p>

            <div style="margin-top:30px; text-align:center; opacity:0.7; font-size:0.8rem;">
                <p>Versi√≥n 2.0 - Hecho con ü§ç para tu bienestar</p>
            </div>
        </div>
    </div>

    <script>
        (function () {
            var themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.addEventListener('change', function () {
                    var theme = themeSelect.value;
                    document.body.classList.toggle('dark', theme === 'dark');
                    // Notify parent
                    window.parent.postMessage({ type: 'themeChange', theme: theme }, '*');
                });
            }

            // Initial check (if parent already has theme)
            window.addEventListener('message', function (event) {
                if (event.data.type === 'applyTheme') {
                    document.body.classList.toggle('dark', event.data.theme === 'dark');
                    if (themeSelect) themeSelect.value = event.data.theme;
                }
            });
        })();
    </script>
        </div>
    </div>

    <div class="menu">
        <button onclick="showSection('home', event)" class="active">üèöÔ∏è<span>Inicio</span></button>
        <button onclick="showSection('alarm', event)">üïú<span>Alarmas</span></button>
        <button onclick="showSection('events', event)">üìã<span>Pendientes</span></button>
        <button onclick="showSection('settings', event)">‚öôÔ∏è<span>Ayuda</span></button>
        <button onclick="showSection('nodie', event)">ü¶Ü<span>Nodie</span></button>
    </div>

    <style>
        @media screen and (max-width: 768px) {
            .lower_navbar_content { flex-direction: column; }
            .lower_navbar .logo { margin-bottom: 10px; }
            .dropdown-menu { width: 100%; }
        }
    </style>

    <script>
        const consejos = [
            "Si solo tienes 30 minutos libres, es mejor relajarte y no dormir",
            "Si quieres chatear con Nodie, revisa *Ayuda*",
            "Nada se compara con contarle tu d√≠a a una persona real",
            "Evita dormir justo antes de tus actividades, podr√≠as sentirte m√°s cansado despu√©s",
            "Un descanso corto puede ayudarte a recuperar energ√≠a y concentraci√≥n",
            "Eres valiente, lo est√°s haciendo bien",
            "Si te sientes agotado, una pausa breve puede marcar la diferencia",
            "Recuerda que descansar tambi√©n es avanzar",
            "T√≥mate un momento para respirar y pensar en ti",
            "No tienes que hacerlo todo hoy, ve paso a paso",
            "Escucha a tu cuerpo, √©l sabe cu√°ndo necesita un respiro",
            "A veces lo mejor que puedes hacer es detenerte un momento",
            "No se trata de hacer m√°s, sino de hacerlo con calma",
            "Descansar no es perder el tiempo, es recuperarlo",
            "Tu bienestar tambi√©n es importante",
            "Una mente tranquila puede con cualquier reto",
            "Hoy tambi√©n cuenta, aunque solo hayas avanzado un poco",
            "Perm√≠tete un momento de silencio, te har√° bien",
            "No siempre tienes que estar al m√°ximo, est√° bien bajar el ritmo",
            "Est√°s creciendo, aprendiendo y avanzando, aunque no siempre lo notes",
            "Cuidarte tambi√©n es parte del progreso",
            "El descanso es parte del camino, no una pausa del destino",
            "Conf√≠a en que est√°s haciendo lo correcto",
            "A veces descansar es la mejor forma de seguir",
            "Tu esfuerzo vale, aunque nadie lo vea",
            "Cada d√≠a es una nueva oportunidad para intentarlo mejor",
            "Hablar con alguien puede ayudarte m√°s de lo que imaginas",
            "No est√°s sola, siempre hay alguien dispuesto a escucharte",
            "A veces compartir lo que sientes alivia m√°s que cualquier descanso",
            "Una buena conversaci√≥n puede cambiarte el d√≠a",
            "Contar lo que te pasa no te hace d√©bil, te hace humana",
            "No todo se soluciona en silencio, hablar tambi√©n sana",
            "Buscar compa√±√≠a cuando lo necesitas es una forma de cuidarte",
            "Hablar con alguien de confianza puede aclarar tu mente",
            "Las palabras compartidas alivian el coraz√≥n",
            "No te guardes todo, hablar tambi√©n libera",
            "A veces solo necesitas que alguien te escuche de verdad",
            "Conectar con alguien puede traer calma a tu d√≠a",
            "Tu voz tambi√©n merece ser escuchada",
            "No est√°s sola/solo, hay personas que se preocupan por ti",
            "Compartir lo que vives hace m√°s ligero el camino",
            "Una charla sincera puede devolverte la paz",
            "Hablar con alguien real te recuerda que no todo se resuelve sola",
            "A veces el mejor descanso es una buena conversaci√≥n",
            "Hablar tambi√©n es una forma de sanar",
            "No tienes que cargar sola con todo lo que sientes"
        ];

        let indice = 0;
        const textoEl = document.getElementById("consejo-texto");

        function cambiarConsejo() {
            if (!textoEl) return;
            textoEl.style.opacity = 0;
            setTimeout(function() {
                indice = (indice + 1) % consejos.length;
                textoEl.textContent = consejos[indice];
                textoEl.style.opacity = 1;
            }, 300);
        }
        setInterval(cambiarConsejo, 6000);
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(function() { console.log('Service Worker registrado'); })
                .catch(function(err) { console.log('Error Service Worker:', err); });
        }
    </script>

    <script>
        function showSection(sectionId, ev) {
            document.querySelectorAll('.section').forEach(function(sec) {
                sec.style.display = 'none';
            });
            var sec = document.getElementById(sectionId);
            if (sec) sec.style.display = 'block';

            document.querySelectorAll('.menu button').forEach(function(btn) {
                btn.classList.remove('active');
            });
            if (ev && ev.currentTarget) ev.currentTarget.classList.add('active');

            // Audio unlock attempt on interaction
            unlockAudio();
        }

        // Global Audio Unlock
        var audioContextUnlocked = false;
        function unlockAudio() {
            if (audioContextUnlocked) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                const context = new AudioContext();
                if (context.state === 'suspended') {
                    context.resume().then(() => {
                        audioContextUnlocked = true;
                        notifyIframes({ type: 'audioUnlocked' });
                    });
                } else {
                    audioContextUnlocked = true;
                    notifyIframes({ type: 'audioUnlocked' });
                }
            }
        }

        // Theme Sync
        window.addEventListener('message', function(event) {
            if (event.data.type === 'themeChange') {
                document.body.classList.toggle('dark', event.data.theme === 'dark');
                notifyIframes({ type: 'applyTheme', theme: event.data.theme });
            }
        });

        function notifyIframes(data) {
            document.querySelectorAll('iframe').forEach(function(iframe) {
                iframe.contentWindow.postMessage(data, '*');
            });
        }
    </script>

</body>
</html>
